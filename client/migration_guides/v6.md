# hide-a-bed v6 Migration Guide

## When to read this

- Teams upgrading projects that currently depend on hide-a-bed v5.x.
- Consumers who maintain custom stubs or wrappers around the public APIs.
- Anyone who relied on the bundled `_changes` helper that shipped before v6.

## Upgrade checklist

- Update hide-a-bed and, if you use the changed feed, install the companion `hide-a-bed-changes` package.
- Run `npm run build` and your existing integration tests against a CouchDB instance or the project stub.

## Breaking changes

### Config object will throw if passed unknown properties

- The `Config` constructor now validates its input and will throw if unknown properties are present.
- Review any custom config objects to ensure only supported properties are included.

### Function errors changed

- Previously all functions were zod validated and would throw `ZodError` on invalid input or output.
- Functions are no longer zod validated by default, inputs and outputs are validated as needed but mostly types are enforced at compile time.
- If you relied on catching `ZodError`, you will need to adjust your error handling to accommodate the new error types thrown by the client.

### View Query keys will be encoded by default

- Previously, users would have to call `encodeURIComponent` on keys passed to view queries that required encoding.
- Now, the client automatically encodes keys.
- If you previously encoded keys manually, you will need to decode them before passing to the query helpers to avoid double-encoding.

### View Query paths types are more strict

- The path string passed to `query` will show a type error if it does not match the `ViewString` union.

```ts
export type ViewString = '_all_docs' | `_design/${string}/_view/${string}`
```

### `_changes` feed split out of the core client

- The polling helper that wrapped `changes-stream` no longer ships inside the client bundle.
- Use the dedicated package shown in [changes/README.md](changes/README.md) to restore the previous feed behaviour.

### Schema builder exports removed

- The legacy `schema.*` namespace is gone; internal Zod v4 Standard Schema assets stay private.
- Test doubles that previously used `schema.BulkSave.implementAsync` now need to migrate to the maintained stub package or copy the v5 schema layer.
- All runtime APIs still accept plain objects, while TypeScript users can import the inferred types exposed from [client/index.mts](client/index.mts) (for example `CouchDoc`, `ViewQueryResponse`).

## Additional opt-in changes

### Validation options

- Some doc and view queries now accept and optional `validate` option
- `bulkGet`, `bulkGetDictionary`, `query`, and `get` all can use and optional `options.validate.docSchema` and friends (see [client/impl/bulkGet.mts](client/impl/bulkGet.mts) and [client/impl/query.mts](client/impl/query.mts)).

```ts
// v5 style
await bulkGet(config, ids)

// v6 style
await bulkGet(config, ids, {
  validate: {
    docSchema,
    onInvalidDoc: 'skip'
  }
})
```
